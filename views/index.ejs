<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>å®¶è¨ˆç°¿</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="stylesheet" href="/stylesheets/colors.css" />
  </head>
  <body>
    <div class="layout">
      <section class="pane pane--left">
        <!-- å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆèµ¤ï¼‰ â€»ãƒ¢ãƒã‚¤ãƒ«ã¯å¾“æ¥é€šã‚Šã€PCã§ã¯staticè¡¨ç¤º -->
        <header class="hero">
          <div class="hero__inner">
            <div class="hero__top">ãƒ›ãƒ¼ãƒ </div>

            <!-- å¥½ãã«å·®ã—æ›¿ãˆå¯ï¼šãƒ€ãƒŸãƒ¼ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
            <div class="hero__stats">
              <div class="stat">
                <div class="stat__label">ä»Šæœˆã®æ”¯å‡º</div>
                <div class="stat__value"><%= Number(expenseTotal || 0).toLocaleString('ja-JP') %>å††</div>
              </div>
              <div class="stat">
                <div class="stat__label">ä»Šæœˆã®åå…¥</div>
                <div class="stat__value"><%= Number(incomeTotal || 0).toLocaleString('ja-JP') %>å††</div>
              </div>
              <div class="stat stat--large">
                <div class="stat__label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­</div>
                <div class="stat__value"><%= Number(totalFiltered || 0).toLocaleString('ja-JP') %>å††</div>
              </div>
            </div>
          </div>
        </header>

        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼‰ -->
        <main class="left-scroll" role="main">
          <%- include('components/section-open', { title: 'ãŠè²·ã„ç‰©ã‚’ç™»éŒ²ã™ã‚‹' }) %>
            <form id="postForm" action="/posts" method="post" class="card-form">
              <div class="field">
                <div class="field__label">é¡Œå</div>
                <div class="field__input with-underline">
                  <input id="title" name="title" type="text" placeholder="ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³" autocomplete="off" />
                  <span class="ok" aria-hidden="true">âœ“</span>
                </div>
              </div>

              <div class="field">
                <div class="field__label">é‡‘é¡</div>
                <div class="seg">
                  <button type="button" id="btnExpense" class="seg__btn seg__btn--active" data-mode="expense">æ”¯å‡º</button>
                  <button type="button" id="btnIncome" class="seg__btn" data-mode="income">åå…¥</button>
                </div>
                <div class="field__input with-underline prefixyen">
                  <span class="yen">Â¥</span>
                  <input id="amount" name="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" inputmode="numeric" placeholder="0" />
                  <span class="ok" aria-hidden="true">âœ“</span>
                </div>
              </div>

              <div class="field">
                <div class="field__label">æ—¥ä»˜</div>
                <div class="field__input with-underline">
                  <input id="createdAt" name="createdAt" type="datetime-local" />
                  <span class="ok" aria-hidden="true">âœ“</span>
                </div>
              </div>

              <input type="hidden" name="userId" value="1" />

              <div class="toolbar">
                <button type="button" class="btn cam" title="å†™çœŸ"><span>ğŸ“·</span></button>
                <button id="submitBtn" class="btn submit" type="submit">ç™»éŒ²ã™ã‚‹</button>
              </div>
            </form>
          <%- include('components/section-close') %>
        </main>
      </section>

      <!-- å³ãƒšã‚¤ãƒ³ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ + å±¥æ­´ï¼ˆç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼‰ -->
      <section class="pane pane--right">
        <main class="right-scroll" role="region" aria-label="å±¥æ­´">
      <%- include('components/section-open', { title: 'ãŠå–å¼•å±¥æ­´' }) %>
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <form action="/" method="post" class="card-form" style="margin-bottom:14px;">
        <div class="field">
          <div class="field__label">ç¨®åˆ¥</div>
          <div class="field__input with-underline">
            <select name="qType" style="width:100%;border:0;outline:0;background:transparent;padding:8px 0;font-size:16px;">
              <option value="" <%= (qType==='')? 'selected' : '' %>>ç„¡é¸æŠ</option>
              <option value="æ”¯å‡º" <%= (qType==='æ”¯å‡º')? 'selected' : '' %>>æ”¯å‡º</option>
              <option value="åå…¥" <%= (qType==='åå…¥')? 'selected' : '' %>>åå…¥</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="field__label">æœŸé–“</div>
          <div class="field__input" style="gap:12px;">
            <div class="with-underline" style="flex:1;">
              <input type="date" name="qDateStart" value="<%= qDateStart || '' %>" style="width:100%;border:0;outline:0;background:transparent;padding:8px 0;font-size:16px;"/>
            </div>
            <span style="color:#aaa;">ã€œ</span>
            <div class="with-underline" style="flex:1;">
              <input type="date" name="qDateEnd" value="<%= qDateEnd || '' %>" style="width:100%;border:0;outline:0;background:transparent;padding:8px 0;font-size:16px;"/>
            </div>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn submit" type="submit">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
        </div>
      </form>
      <ul class="tx-list">
        <% if (Array.isArray(result) && result.length) { %>
          <% result.forEach(function(p){ %>
            <li class="tx-item" style="cursor:pointer;">
              <a href="/detail?id=<%= p.id %>" style="text-decoration:none;color:inherit;display:flex;justify-content:space-between;align-items:center;width:100%;">
                <div class="tx-left">
                  <div class="tx-icon" aria-hidden="true">ğŸ·ï¸</div>
                  <div class="tx-text">
                    <div class="tx-title"><%= p.title || p.name || p.message || 'POST' %></div>
                    <% 
                      let dispDate = '';
                      try {
                        const dsrc = p.createdAt || p.date;
                        if (dsrc) {
                          const d = new Date(dsrc);
                          const parts = new Intl.DateTimeFormat('ja-JP', {
                            timeZone: 'Asia/Tokyo',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            weekday: 'short',
                            hour12: false,
                          }).formatToParts(d);
                          const obj = Object.fromEntries(parts.map(p=>[p.type,p.value]));
                          dispDate = `${obj.year}å¹´${obj.month}æœˆ${obj.day}æ—¥ ${obj.weekday} ${obj.hour}:${obj.minute}`;
                        }
                      } catch(e) {}
                    %>
                    <div class="tx-date"><%= dispDate %></div>
                  </div>
                </div>
                <% 
                  var amountRaw = (p.amount ?? p.price ?? '');
                  var n = Number(amountRaw);
                  var cls = isNaN(n) ? '' : (n >= 0 ? 'tx-amount--pos' : 'tx-amount--neg');
                  var text = (amountRaw === '' ? '' : (isNaN(n) ? ('Â¥'+amountRaw) : ((n>0?'+ ':'')+'Â¥'+Math.abs(n))));
                %>
                <div class="tx-amount <%= cls %>"><%= text %></div>
              </a>
            </li>
          <% }) %>
        <% } else { %>
          <li class="tx-empty">æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</li>
        <% } %>
      </ul>
    <%- include('components/section-close') %>
        </main>
      </section>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        let mode = 'expense'; // expense: æ­£(+), income: è² (-)
        const btnExpense = document.getElementById('btnExpense');
        const btnIncome = document.getElementById('btnIncome');
        const amountEl  = document.getElementById('amount');
        const titleEl   = document.getElementById('title');
        const dateEl    = document.getElementById('createdAt');
        const formEl    = document.getElementById('postForm');

        if (!formEl) return;

        function pad(n){return String(n).padStart(2,'0');}
        function nowLocalISO(){
          const d = new Date();
          const yyyy = d.getFullYear();
          const MM = pad(d.getMonth()+1);
          const dd = pad(d.getDate());
          const hh = pad(d.getHours());
          const mm = pad(d.getMinutes());
          return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
        }
        if (dateEl) dateEl.value = nowLocalISO();

        function setMode(next){
          mode = next;
          btnExpense.classList.toggle('seg__btn--active', mode==='expense');
          btnIncome.classList.toggle('seg__btn--active', mode==='income');
        }

        btnExpense && btnExpense.addEventListener('click', ()=> setMode('expense'));
        btnIncome && btnIncome.addEventListener('click', ()=> setMode('income'));

        // æ•°å­—ä»¥å¤–ã®å…¥åŠ›ã‚’é™¤å»ï¼ˆè²¼ã‚Šä»˜ã‘å«ã‚€ï¼‰
        amountEl && amountEl.addEventListener('input', function(){
          const digits = (amountEl.value || '').replace(/[^0-9]/g, '');
          amountEl.value = digits;
        });

        formEl.addEventListener('submit', function(){
          const raw = Number(amountEl.value || 0);
          const abs = Math.abs(raw);
          const signed = (mode === 'income') ? -abs : abs;
          amountEl.value = String(signed);
          // ãã®ã¾ã¾é€ä¿¡
        });
      });
    </script>
  </body>
</html>
