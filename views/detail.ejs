<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>è©³ç´°</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="stylesheet" href="/stylesheets/colors.css" />
    <style>
      .detail-hero{
        position:relative;
        z-index:1;
        /* ãƒ•ãƒ«ãƒ–ãƒªãƒ¼ãƒ‰ï¼ˆè¦ªã®å·¦å³ä½™ç™½ã‚’ç„¡è¦–ã—ã¦ç”»é¢ã„ã£ã±ã„ï¼‰ */
        width:100vw;
        margin-left:calc(50% - 50vw);
        margin-right:calc(50% - 50vw);
        /* è‰²ã¨å½¢ */
        background:var(--rose, #e03a53);
        color:#fff;
        border-bottom-left-radius:40px;
        border-bottom-right-radius:40px;
        overflow:hidden; /* è§’ä¸¸ã‚’ç¢ºå®Ÿã«åæ˜  */
        padding: max(16px, env(safe-area-inset-top)) 20px 48px;
        min-height: 220px; /* è¦‹æœ¬ã®é«˜ã•æ„Ÿ */
      }
      /* ç½®ãæ›ãˆï¼š.detail-hero */
      .detail-hero{
        position: relative;
        z-index: 1;
        /* ç”»é¢å¹…ã„ã£ã±ã„ã«ï¼ˆè¦ªã®å·¦å³ä½™ç™½ã‚’ç„¡è¦–ï¼‰ */
        width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);

        background: var(--rose, #e03a53);
        color: #fff;
        border-bottom-left-radius: 40px;
        border-bottom-right-radius: 40px;
        overflow: hidden;                /* è§’ä¸¸ã‚’ç¢ºå®Ÿã«åæ˜  */
        padding: max(16px, env(safe-area-inset-top)) 20px 48px;
        min-height: 220px;

        /* ä¸­å¤®æƒãˆ */
        display: flex;
        flex-direction: column;
        align-items: center;             /* æ¨ªæ–¹å‘ã‚»ãƒ³ã‚¿ãƒ¼ */
        text-align: center;              /* ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤® */
      }

      /* ç½®ãæ›ãˆï¼š.detail-hero .nav / .back */
      .detail-hero .nav{
        display:flex;
        align-items:center;
        justify-content:center;          /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¸­å¤® */
        position:relative;
        width:100%;
      }
      .detail-hero .back{
        position:absolute;               /* æˆ»ã‚‹ã¯å·¦å›ºå®š */
        left:16px;
        color:#fff;
        text-decoration:none;
        font-size:22px;
      }

      /* ç½®ãæ›ãˆï¼šã‚¿ã‚¤ãƒˆãƒ«ãƒ»é‡‘é¡ã‚‚ç¢ºå®Ÿã«ç™½ï¼†ä¸­å¤® */
      .detail-hero .title{font-size:14px; opacity:.95; margin-top:8px; color:#fff; text-align:center;}
      .detail-hero .amount{font-size:56px; line-height:1.1; font-weight:800; margin:10px 0; color:#fff; text-align:center;}
      .detail-hero .yen{font-size:.6em; margin-left:6px;}

      /* ç½®ãæ›ãˆï¼šãƒãƒƒãƒ—ã¨æ—¥ä»˜ã‚‚ä¸­å¤®ã« */
      .chip{
        display:inline-block;
        padding:8px 18px;
        border-radius:12px;
        background:#fff;
        color:var(--rose, #e03a53);
        font-weight:700;
        margin:10px auto 0;              /* ä¸­å¤®å¯„ã› */
      }
      .chip.income{ background:rgba(255,255,255,.9); color:#333; }

      .date{ color:#fff; opacity:.9; text-align:center; }
      .section{padding:20px}
      .fake-form{height:220px;border-radius:8px;background:#e5e5e5;display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;margin:12px 0 18px}
      .btn{width:100%;padding:16px;border-radius:12px;font-weight:800;cursor:pointer}
      .btn-outline{border:2px solid var(--rose);background:#fff;color:var(--rose)}
      .btn-danger{border:2px solid var(--rose);background:transparent;color:var(--rose)}
      .errmsg{margin:12px 16px;color:#b91c1c;font-weight:700}

      @media (min-width: 1000px){
        .detail-hero{
          width:auto;
          margin-left:0;
          margin-right:0;
          border-bottom-left-radius:24px;
          border-bottom-right-radius:24px;
        }
      }

      /* Mobile: small padding around right pane soä¸Šéƒ¨ãŒéš ã‚Œãªã„å•é¡Œã‚’å›é¿ */
      @media (max-width: 999px){
        .pane--right .right-scroll{ padding:16px; }
      }

      .seg{display:inline-flex; gap:8px; background:#f3f4f6; padding:6px; border-radius:10px}
      .seg__btn{border:0; background:transparent; padding:8px 14px; border-radius:8px; font-weight:700; cursor:pointer}
      .seg__btn--active{background:#111; color:#fff}
    </style>
  </head>
  <body>
    <% if (error) { %>
      <div class="errmsg"><%= error %></div>
    <% } %>

    <div class="layout">
      <!-- Left pane: header -->
      <section class="pane pane--left">
        <header class="detail-hero">
          <div class="nav"><a class="back" href="/">â€¹</a><div style="flex:1;text-align:center;font-weight:700">è©³ç´°</div></div>
          <% if (item) { 
               const n = Number(item.amount||0);
               const isExpense = n >= 0;
          %>
            <div class="title"><%= item.title || '' %></div>
            <div class="amount"><%= Math.abs(n).toLocaleString('ja-JP') %><span class="yen">å††</span></div>
            <div style="margin-top:6px;">
              <span class="chip <%= isExpense ? '' : 'income' %>"><%= isExpense ? 'æ”¯å‡º' : 'åå…¥' %></span>
            </div>
            <div class="date" style="margin-top:8px;">
              <% 
                let dispDate = '';
                try {
                  const d = new Date(item.createdAt);
                  const parts = new Intl.DateTimeFormat('ja-JP', {
                    timeZone: 'Asia/Tokyo', year:'numeric', month:'2-digit', day:'2-digit',
                    hour:'2-digit', minute:'2-digit', weekday:'short', hour12:false
                  }).formatToParts(d);
                  const obj = Object.fromEntries(parts.map(p=>[p.type,p.value]));
                  dispDate = `${obj.year}å¹´${obj.month}æœˆ${obj.day}æ—¥ ${obj.weekday} ${obj.hour}:${obj.minute}`;
                } catch(e) {}
              %>
              <%= dispDate %>
            </div>
          <% } %>
        </header>
        <%- include('components/section-open', { title: 'ã‚¢ã‚¤ãƒ†ãƒ ã®ç·¨é›† / å‰Šé™¤' }) %>

          <% if (item) { 
               // datetime-local ã® value ç”¨ã«æ—¥æœ¬æ™‚é–“ã§YYYY-MM-DDTHH:MM
               let dtValue = '';
               try {
                 const d = new Date(item.createdAt);
                 // toLocaleString ã§ã¯ãªãã€æ‰‹çµ„ã¿ã§ã‚¼ãƒ­åŸ‹ã‚
                 const pad = (n)=> String(n).padStart(2,'0');
                 const y = d.getFullYear();
                 const m = pad(d.getMonth()+1);
                 const da = pad(d.getDate());
                 const hh = pad(d.getHours());
                 const mm = pad(d.getMinutes());
                 dtValue = `${y}-${m}-${da}T${hh}:${mm}`;
               } catch(e) {}
          %>

          <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
          <form action="/detail/edit?id=<%= item.id %>" method="post" class="card-form">
            <div class="field">
              <div class="field__label">é¡Œå</div>
              <div class="field__input with-underline">
                <input id="title" name="title" type="text" value="<%= item.title || '' %>" autocomplete="off" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="field">
              <div class="field__label">é‡‘é¡</div>
              <div class="field__input with-underline prefixyen">
                <span class="yen">Â¥</span>
                <input id="amount" name="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" value="<%= Math.abs(Number(item.amount||0)) %>" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="field">
              <div class="field__label">ç¨®åˆ¥</div>
              <div class="field__input with-underline">
                <% const __qType = (Number(item.amount||0) < 0) ? 'æ”¯å‡º' : 'åå…¥'; %>
                <input type="hidden" name="qType" id="qTypeEdit" value="<%= __qType %>">
                <div class="seg">
                  <button type="button" id="btnExpenseEdit" class="seg__btn <%= (__qType==='æ”¯å‡º')? 'seg__btn--active' : '' %>" data-mode="expense">æ”¯å‡º</button>
                  <button type="button" id="btnIncomeEdit" class="seg__btn <%= (__qType==='åå…¥')? 'seg__btn--active' : '' %>" data-mode="income">åå…¥</button>
                </div>
              </div>
            </div>

            <div class="field">
              <div class="field__label">æ—¥ä»˜</div>
              <div class="field__input with-underline">
                <input id="createdAt" name="createdAt" type="datetime-local" value="<%= dtValue %>" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="toolbar">
              <button class="btn submit" type="submit">ç·¨é›†ã™ã‚‹</button>
            </div>
          </form>

          <!-- å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
          <form action="/detail/delete?id=<%= item.id %>" method="post" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="margin-top:14px;">
            <button class="btn btn-danger" type="submit">å‰Šé™¤ã™ã‚‹</button>
          </form>

          <% } else { %>
            <div class="fake-form">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <% } %>

          <%- include('components/section-close') %>
      </section>

      <!-- Right pane: forms -->
      <section class="pane pane--right">
        <main class="right-scroll">
          <%- include('components/section-open', { title: 'è³¼å…¥å•†å“ä¸€è¦§' }) %>
          <style>
            .item-list{ list-style:none; padding:0; margin:0; }
            .item-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 8px; border-bottom:1px solid #eee; }
            .item-row .left{ display:flex; align-items:center; gap:10px; min-width:0; }
            .item-row .dot{ width:10px; height:10px; border-radius:50%; background:#e03a53; flex:0 0 10px; }
            .item-row .title{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
            .item-row .amount{ font-variant-numeric: tabular-nums; font-weight:800; }
            .icon-btn{ background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; padding:6px; }
            .inline-form{ display:inline; margin:0; }
          </style>
          <ul class="item-list">
            <% if (Array.isArray(items) && items.length) { %>
              <% items.forEach(function(it){ %>
                <li class="item-row">
                  <div class="left">
                    <span class="dot" aria-hidden="true"></span>
                    <span class="title"><%= it.title || 'ITEM' %></span>
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <span class="amount"><%= (Number(it.amount)||0) >= 0 ? ('+Â¥'+Math.abs(Number(it.amount))) : ('-Â¥'+Math.abs(Number(it.amount))) %></span>
                    <form class="inline-form" action="/detail/items/<%= it.id %>/delete?id=<%= item.id %>" method="post" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                      <button class="icon-btn" type="submit" aria-label="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </form>
                  </div>
                </li>
              <% }) %>
            <% } else { %>
              <li class="item-row"><div class="left"><span class="dot" aria-hidden="true"></span><span class="title">ã‚¢ã‚¤ãƒ†ãƒ ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</span></div></li>
            <% } %>
          </ul>
          <%- include('components/section-close') %>
          <%- include('components/section-open', { title: 'è³¼å…¥ã‚¢ã‚¤ãƒ†ãƒ ã®è¿½åŠ ' }) %>

          <% if (item) { 
               let dtValue = '';
               try {
                 const d = new Date();
                 const pad = (n)=> String(n).padStart(2,'0');
                 const y = d.getFullYear();
                 const m = pad(d.getMonth()+1);
                 const da = pad(d.getDate());
                 const hh = pad(d.getHours());
                 const mm = pad(d.getMinutes());
                 dtValue = `${y}-${m}-${da}T${hh}:${mm}`;
               } catch(e) {}
          %>

          <!-- è³¼å…¥ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¡ãƒ¢ç”¨é€”ï¼šé‡‘é¡ãƒãƒªãƒ‡ãªã—ï¼‰ -->
          <form action="/detail/items/add?id=<%= item.id %>" method="post" class="card-form">
            <div class="field">
              <div class="field__label">å•†å“å</div>
              <div class="field__input with-underline">
                <input id="title" name="title" type="text" value="" autocomplete="off" placeholder="ãŠã«ãã‚Šã€ãƒãƒ¼ã‚º ãªã©" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="field">
              <div class="field__label">é‡‘é¡ï¼ˆæ•°å­—ã®ã¿ï¼‰</div>
              <div class="field__input with-underline prefixyen">
                <span class="yen">Â¥</span>
                <input id="amount" name="amount" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="ä¾‹: 200" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="field">
              <div class="field__label">ç¨®åˆ¥</div>
              <div class="field__input with-underline">
                <input type="hidden" name="qType" id="qTypeAdd" value="æ”¯å‡º">
                <div class="seg">
                  <button type="button" id="btnExpenseAdd" class="seg__btn seg__btn--active" data-mode="expense">æ”¯å‡º</button>
                  <button type="button" id="btnIncomeAdd" class="seg__btn" data-mode="income">åå…¥</button>
                </div>
              </div>
            </div>

            <div class="field">
              <div class="field__label">æ—¥ä»˜</div>
              <div class="field__input with-underline">
                <input id="createdAt" name="createdAt" type="datetime-local" value="<%= dtValue %>" />
                <span class="ok" aria-hidden="true">âœ“</span>
              </div>
            </div>

            <div class="toolbar">
              <button class="btn submit" type="submit">è¿½åŠ ã™ã‚‹</button>
            </div>
          </form>

          <% } else { %>
            <div class="fake-form">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <% } %>

          <%- include('components/section-close') %>
        </main>
      </section>
    </div>
</main>
  <script>
    (function(){
      function setupSeg(expenseBtnId, incomeBtnId, inputId){
        const $exp = document.getElementById(expenseBtnId);
        const $inc = document.getElementById(incomeBtnId);
        const $in  = document.getElementById(inputId);
        if(!$exp || !$inc || !$in) return;
        function activate(mode){
          if(mode==='expense'){
            $exp.classList.add('seg__btn--active');
            $inc.classList.remove('seg__btn--active');
            $in.value = 'æ”¯å‡º';
          }else{
            $inc.classList.add('seg__btn--active');
            $exp.classList.remove('seg__btn--active');
            $in.value = 'åå…¥';
          }
        }
        $exp.addEventListener('click', ()=> activate('expense'));
        $inc.addEventListener('click', ()=> activate('income'));
      }
      // å·¦ãƒšã‚¤ãƒ³ï¼ˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
      setupSeg('btnExpenseEdit','btnIncomeEdit','qTypeEdit');
      // å³ãƒšã‚¤ãƒ³ï¼ˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
      setupSeg('btnExpenseAdd','btnIncomeAdd','qTypeAdd');
    })();
  </script>
  </body>
</html>
